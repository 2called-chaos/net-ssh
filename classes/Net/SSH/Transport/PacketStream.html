<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>Net::SSH::Transport::PacketStream</title>
    <meta content='text/html; charset=US-ASCII' http-equiv='Content-Type'>
    <link href='../../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>module</span>
          Net::SSH::Transport::PacketStream
        </h1>
        <ol class='paths'>
          <li>
            <a target="docwin" href="../../../../files/lib/net/ssh/transport/packet_stream_rb.html">lib/net/ssh/transport/packet_stream.rb</a>
          </li>
        </ol>
        <div class='parent'>
          Parent:
          <strong><a target="docwin" href="../Transport.html">Transport</a></strong>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            
            <p>A module that builds additional functionality onto the Net::SSH::BufferedIo
            module. It adds <a href="../../SSH.html">SSH</a> encryption, compression,
            and packet validation, as per the SSH2 protocol. It also adds an
            abstraction for polling packets, to allow for both blocking and
            non-blocking reads.</p>
          </div>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>Public Class</h3>
            <ol>
              <li><a target="docwin" href="#method-c-extended">extended</a></li>
            </ol>
            <h3>Public Instance</h3>
            <ol>
              <li><a target="docwin" href="#method-i-available_for_read-3F">available_for_read?</a></li>
              <li><a target="docwin" href="#method-i-cleanup">cleanup</a></li>
              <li><a target="docwin" href="#attribute-i-client">client</a></li>
              <li><a target="docwin" href="#method-i-client_name">client_name</a></li>
              <li><a target="docwin" href="#method-i-enqueue_packet">enqueue_packet</a></li>
              <li><a target="docwin" href="#attribute-i-hints">hints</a></li>
              <li><a target="docwin" href="#method-i-if_needs_rekey-3F">if_needs_rekey?</a></li>
              <li><a target="docwin" href="#method-i-next_packet">next_packet</a></li>
              <li><a target="docwin" href="#method-i-peer_ip">peer_ip</a></li>
              <li><a target="docwin" href="#method-i-send_packet">send_packet</a></li>
              <li><a target="docwin" href="#attribute-i-server">server</a></li>
            </ol>
            <h3>Protected Instance</h3>
            <ol>
              <li><a target="docwin" href="#method-i-initialize_ssh">initialize_ssh</a></li>
              <li><a target="docwin" href="#method-i-poll_next_packet">poll_next_packet</a></li>
            </ol>
          </div>
          <div id='context'>
            <div id='includes'>
              <h2>Included modules</h2>
              <ol>
                <li>BufferedIo</li>
              </ol>
            </div>
          </div>
          <div id='section'>
            <div id='attribute-list'>
              <h2 class='section-bar'>Attributes</h2>
              <div class='name-list'>
                <table>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>
                      <a name='attribute-i-client'>client</a>
                    </td>
                    <td class='context-item-value'>[R]</td>
                    <td class='context-item-desc'>
                      
                      <p>The client state object, which encapsulates the algorithms used to build
                      packets to send to the server.</p>
                    </td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>
                      <a name='attribute-i-hints'>hints</a>
                    </td>
                    <td class='context-item-value'>[R]</td>
                    <td class='context-item-desc'>
                      
                      <p>The map of "hints" that can be used to modify the behavior of the packet
                      stream. For instance, when authentication succeeds, an "authenticated" hint
                      is set, which is used to determine whether or not to compress the data when
                      using the "delayed" compression algorithm.</p>
                    </td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>
                      <a name='attribute-i-server'>server</a>
                    </td>
                    <td class='context-item-value'>[R]</td>
                    <td class='context-item-desc'>
                      
                      <p>The server state object, which encapsulates the algorithms used to
                      interpret packets coming from the server.</p>
                    </td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='methods'>
              <h2>Public Class methods</h2>
              <div class='method public-class' id='method-method-c-extended'>
                <a name='method-c-extended'></a>
                <div class='synopsis'>
                  <span class='name'>extended</span>
                  <span class='arguments'>(object)</span>
                </div>
                <div class='description'>
                  
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-c-extended-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-c-extended-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 19</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">extended</span>(<span class="ruby-identifier">object</span>)&#x000A;  <span class="ruby-identifier">object</span>.<span class="ruby-identifier">__send__</span>(<span class="ruby-value">:initialize_ssh</span>)&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <h2>Public Instance methods</h2>
              <div class='method public-instance' id='method-method-i-available_for_read-3F'>
                <a name='method-i-available_for_read-3F'></a>
                <div class='synopsis'>
                  <span class='name'>available_for_read?</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>Returns true if the IO is available for reading, and false otherwise.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-available_for_read-3F-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-available_for_read-3F-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 72</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">available_for_read?</span>&#x000A;  <span class="ruby-identifier">result</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Compat</span>.<span class="ruby-identifier">io_select</span>([<span class="ruby-keyword">self</span>], <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-value">0</span>)&#x000A;  <span class="ruby-identifier">result</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">any?</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-cleanup'>
                <a name='method-i-cleanup'></a>
                <div class='synopsis'>
                  <span class='name'>cleanup</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>Performs any pending cleanup necessary on the IO and its associated state
                  objects. (See <a
                  href="State.html#method-i-cleanup">Net::SSH::Transport::State#cleanup</a>).</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-cleanup-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-cleanup-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 159</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">cleanup</span>&#x000A;  <span class="ruby-identifier">client</span>.<span class="ruby-identifier">cleanup</span>&#x000A;  <span class="ruby-identifier">server</span>.<span class="ruby-identifier">cleanup</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-client_name'>
                <a name='method-i-client_name'></a>
                <div class='synopsis'>
                  <span class='name'>client_name</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>The name of the client (local) end of the socket, as reported by the
                  socket.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-client_name-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-client_name-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 39</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">client_name</span>&#x000A;  <span class="ruby-ivar">@client_name</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">begin</span>&#x000A;    <span class="ruby-identifier">sockaddr</span> = <span class="ruby-identifier">getsockname</span>&#x000A;    <span class="ruby-keyword">begin</span>&#x000A;      <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">getnameinfo</span>(<span class="ruby-identifier">sockaddr</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">NI_NAMEREQD</span>).<span class="ruby-identifier">first</span>&#x000A;    <span class="ruby-keyword">rescue</span>&#x000A;      <span class="ruby-keyword">begin</span>&#x000A;        <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">getnameinfo</span>(<span class="ruby-identifier">sockaddr</span>).<span class="ruby-identifier">first</span>&#x000A;      <span class="ruby-keyword">rescue</span>&#x000A;        <span class="ruby-keyword">begin</span>&#x000A;          <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">gethostbyname</span>(<span class="ruby-constant">Socket</span>.<span class="ruby-identifier">gethostname</span>).<span class="ruby-identifier">first</span>&#x000A;        <span class="ruby-keyword">rescue</span>&#x000A;          <span class="ruby-identifier">lwarn</span> { <span class="ruby-string">&quot;the client ipaddr/name could not be determined&quot;</span> }&#x000A;          <span class="ruby-string">&quot;unknown&quot;</span>&#x000A;        <span class="ruby-keyword">end</span>&#x000A;      <span class="ruby-keyword">end</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-enqueue_packet'>
                <a name='method-i-enqueue_packet'></a>
                <div class='synopsis'>
                  <span class='name'>enqueue_packet</span>
                  <span class='arguments'>(payload)</span>
                </div>
                <div class='description'>
                  
                  <p>Enqueues a packet to be sent, but does not immediately send the packet. The
                  given payload is pre-processed according to the algorithms specified in the
                  client state (compression, cipher, and hmac).</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-enqueue_packet-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-enqueue_packet-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 122</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">enqueue_packet</span>(<span class="ruby-identifier">payload</span>)&#x000A;  <span class="ruby-comment"># try to compress the packet</span>&#x000A;  <span class="ruby-identifier">payload</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">compress</span>(<span class="ruby-identifier">payload</span>)&#x000A;&#x000A;  <span class="ruby-comment"># the length of the packet, minus the padding</span>&#x000A;  <span class="ruby-identifier">actual_length</span> = <span class="ruby-value">4</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>&#x000A;&#x000A;  <span class="ruby-comment"># compute the padding length</span>&#x000A;  <span class="ruby-identifier">padding_length</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">actual_length</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">block_size</span>)&#x000A;  <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span>&#x000A;&#x000A;  <span class="ruby-comment"># compute the packet length (sans the length field itself)</span>&#x000A;  <span class="ruby-identifier">packet_length</span> = <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>&#x000A;&#x000A;  <span class="ruby-keyword">if</span> <span class="ruby-identifier">packet_length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">16</span>&#x000A;    <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">block_size</span>&#x000A;    <span class="ruby-identifier">packet_length</span> = <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;&#x000A;  <span class="ruby-identifier">padding</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">padding_length</span>) { <span class="ruby-identifier">rand</span>(<span class="ruby-value">256</span>) }.<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;C*&quot;</span>)&#x000A;&#x000A;  <span class="ruby-identifier">unencrypted_data</span> = [<span class="ruby-identifier">packet_length</span>, <span class="ruby-identifier">padding_length</span>, <span class="ruby-identifier">payload</span>, <span class="ruby-identifier">padding</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;NCA*A*&quot;</span>)&#x000A;  <span class="ruby-identifier">mac</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">digest</span>([<span class="ruby-identifier">client</span>.<span class="ruby-identifier">sequence_number</span>, <span class="ruby-identifier">unencrypted_data</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;NA*&quot;</span>))&#x000A;&#x000A;  <span class="ruby-identifier">encrypted_data</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">unencrypted_data</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">final_cipher</span>&#x000A;  <span class="ruby-identifier">message</span> = <span class="ruby-identifier">encrypted_data</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">mac</span>&#x000A;&#x000A;  <span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;queueing packet nr #{client.sequence_number} type #{payload.getbyte(0)} len #{packet_length}&quot;</span> }&#x000A;  <span class="ruby-identifier">enqueue</span>(<span class="ruby-identifier">message</span>)&#x000A;&#x000A;  <span class="ruby-identifier">client</span>.<span class="ruby-identifier">increment</span>(<span class="ruby-identifier">packet_length</span>)&#x000A;&#x000A;  <span class="ruby-keyword">self</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-if_needs_rekey-3F'>
                <a name='method-i-if_needs_rekey-3F'></a>
                <div class='synopsis'>
                  <span class='name'>if_needs_rekey?</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>If the IO object requires a rekey operation (as indicated by either its
                  client or server state objects, see <a
                  href="State.html#method-i-needs_rekey-3F">Net::SSH::Transport::State#needs_rekey?</a>),
                  this will yield. Otherwise, this does nothing.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-if_needs_rekey-3F-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-if_needs_rekey-3F-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 167</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">if_needs_rekey?</span>&#x000A;  <span class="ruby-keyword">if</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">needs_rekey?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">needs_rekey?</span>&#x000A;    <span class="ruby-keyword">yield</span>&#x000A;    <span class="ruby-identifier">client</span>.<span class="ruby-identifier">reset!</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">needs_rekey?</span>&#x000A;    <span class="ruby-identifier">server</span>.<span class="ruby-identifier">reset!</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">needs_rekey?</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-next_packet'>
                <a name='method-i-next_packet'></a>
                <div class='synopsis'>
                  <span class='name'>next_packet</span>
                  <span class='arguments'>(mode=:nonblock)</span>
                </div>
                <div class='description'>
                  
                  <p>Returns the next full packet. If the mode parameter is :nonblock (the
                  default), then this will return immediately, whether a packet is available
                  or not, and will return nil if there is no packet ready to be returned. If
                  the mode parameter is :block, then this method will block until a packet is
                  available.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-next_packet-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-next_packet-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 82</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">next_packet</span>(<span class="ruby-identifier">mode</span>=<span class="ruby-value">:nonblock</span>)&#x000A;  <span class="ruby-keyword">case</span> <span class="ruby-identifier">mode</span>&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:nonblock</span> <span class="ruby-keyword">then</span>&#x000A;    <span class="ruby-keyword">if</span> <span class="ruby-identifier">available_for_read?</span>&#x000A;      <span class="ruby-keyword">if</span> <span class="ruby-identifier">fill</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>&#x000A;        <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Disconnect</span>, <span class="ruby-string">&quot;connection closed by remote host&quot;</span>&#x000A;      <span class="ruby-keyword">end</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;    <span class="ruby-identifier">poll_next_packet</span>&#x000A;&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>&#x000A;    <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>&#x000A;      <span class="ruby-identifier">packet</span> = <span class="ruby-identifier">poll_next_packet</span>&#x000A;      <span class="ruby-keyword">return</span> <span class="ruby-identifier">packet</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">packet</span>&#x000A;&#x000A;      <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>&#x000A;        <span class="ruby-identifier">result</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Compat</span>.<span class="ruby-identifier">io_select</span>([<span class="ruby-keyword">self</span>]) <span class="ruby-keyword">or</span> <span class="ruby-keyword">next</span>&#x000A;        <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">any?</span>&#x000A;      <span class="ruby-keyword">end</span>&#x000A;&#x000A;      <span class="ruby-keyword">if</span> <span class="ruby-identifier">fill</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>&#x000A;        <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Disconnect</span>, <span class="ruby-string">&quot;connection closed by remote host&quot;</span>&#x000A;      <span class="ruby-keyword">end</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;&#x000A;  <span class="ruby-keyword">else</span>&#x000A;    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;expected :block or :nonblock, got #{mode.inspect}&quot;</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-peer_ip'>
                <a name='method-i-peer_ip'></a>
                <div class='synopsis'>
                  <span class='name'>peer_ip</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>The IP address of the peer (remote) end of the socket, as reported by the
                  socket.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-peer_ip-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-peer_ip-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 61</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">peer_ip</span>&#x000A;  <span class="ruby-ivar">@peer_ip</span> <span class="ruby-operator">||=</span>&#x000A;    <span class="ruby-keyword">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:getpeername</span>)&#x000A;      <span class="ruby-identifier">addr</span> = <span class="ruby-identifier">getpeername</span>&#x000A;      <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">getnameinfo</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">NI_NUMERICHOST</span> <span class="ruby-operator">|</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">NI_NUMERICSERV</span>).<span class="ruby-identifier">first</span>&#x000A;    <span class="ruby-keyword">else</span>&#x000A;      <span class="ruby-string">&quot;&lt;no hostip for proxy command&gt;&quot;</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-send_packet'>
                <a name='method-i-send_packet'></a>
                <div class='synopsis'>
                  <span class='name'>send_packet</span>
                  <span class='arguments'>(payload)</span>
                </div>
                <div class='description'>
                  
                  <p>Enqueues a packet to be sent, and blocks until the entire packet is sent.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-send_packet-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-send_packet-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 114</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">send_packet</span>(<span class="ruby-identifier">payload</span>)&#x000A;  <span class="ruby-identifier">enqueue_packet</span>(<span class="ruby-identifier">payload</span>)&#x000A;  <span class="ruby-identifier">wait_for_pending_sends</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <h2>Protected Instance methods</h2>
              <div class='method protected-instance' id='method-method-i-initialize_ssh'>
                <a name='method-i-initialize_ssh'></a>
                <div class='synopsis'>
                  <span class='name'>initialize_ssh</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>Called when this module is used to extend an object. It initializes the
                  states and generally prepares the object for use as a packet stream.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-initialize_ssh-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-initialize_ssh-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 179</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize_ssh</span>&#x000A;  <span class="ruby-ivar">@hints</span>  = {}&#x000A;  <span class="ruby-ivar">@server</span> = <span class="ruby-constant">State</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword">self</span>, <span class="ruby-value">:server</span>)&#x000A;  <span class="ruby-ivar">@client</span> = <span class="ruby-constant">State</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword">self</span>, <span class="ruby-value">:client</span>)&#x000A;  <span class="ruby-ivar">@packet</span> = <span class="ruby-keyword">nil</span>&#x000A;  <span class="ruby-identifier">initialize_buffered_io</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method protected-instance' id='method-method-i-poll_next_packet'>
                <a name='method-i-poll_next_packet'></a>
                <div class='synopsis'>
                  <span class='name'>poll_next_packet</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>Tries to read the next packet. If there is insufficient data to read an
                  entire packet, this returns immediately, otherwise the packet is read,
                  post-processed according to the cipher, hmac, and compression algorithms
                  specified in the server state object, and returned as a new <a
                  href="../Packet.html">Packet</a> object.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-poll_next_packet-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-poll_next_packet-source'><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 192</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">poll_next_packet</span>&#x000A;  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">nil?</span>&#x000A;    <span class="ruby-identifier">minimum</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span> <span class="ruby-operator">?</span> <span class="ruby-value">4</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">block_size</span>&#x000A;    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">available</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">minimum</span>&#x000A;    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">read_available</span>(<span class="ruby-identifier">minimum</span>)&#x000A;&#x000A;    <span class="ruby-comment"># decipher it</span>&#x000A;    <span class="ruby-ivar">@packet</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Buffer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">data</span>))&#x000A;    <span class="ruby-ivar">@packet_length</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read_long</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;&#x000A;  <span class="ruby-identifier">need</span> = <span class="ruby-ivar">@packet_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">block_size</span>&#x000A;  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-node">&quot;padding error, need #{need} block #{server.block_size}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">need</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>&#x000A;&#x000A;  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">available</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">need</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">mac_length</span>&#x000A;&#x000A;  <span class="ruby-keyword">if</span> <span class="ruby-identifier">need</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>&#x000A;    <span class="ruby-comment"># read the remainder of the packet and decrypt it.</span>&#x000A;    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">read_available</span>(<span class="ruby-identifier">need</span>)&#x000A;    <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">append</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">data</span>))&#x000A;  <span class="ruby-keyword">end</span>&#x000A;&#x000A;  <span class="ruby-comment"># get the hmac from the tail of the packet (if one exists), and</span>&#x000A;  <span class="ruby-comment"># then validate it.</span>&#x000A;  <span class="ruby-identifier">real_hmac</span> = <span class="ruby-identifier">read_available</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">mac_length</span>) <span class="ruby-operator">||</span> <span class="ruby-string">&quot;&quot;</span>&#x000A;&#x000A;  <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">append</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">final_cipher</span>)&#x000A;  <span class="ruby-identifier">padding_length</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read_byte</span>&#x000A;&#x000A;  <span class="ruby-identifier">payload</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read</span>(<span class="ruby-ivar">@packet_length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)&#x000A;&#x000A;  <span class="ruby-identifier">my_computed_hmac</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">digest</span>([<span class="ruby-identifier">server</span>.<span class="ruby-identifier">sequence_number</span>, <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">content</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;NA*&quot;</span>))&#x000A;  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&quot;corrupted mac detected&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">real_hmac</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">my_computed_hmac</span>&#x000A;&#x000A;  <span class="ruby-comment"># try to decompress the payload, in case compression is active</span>&#x000A;  <span class="ruby-identifier">payload</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">decompress</span>(<span class="ruby-identifier">payload</span>)&#x000A;&#x000A;  <span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;received packet nr #{server.sequence_number} type #{payload.getbyte(0)} len #{@packet_length}&quot;</span> }&#x000A;&#x000A;  <span class="ruby-identifier">server</span>.<span class="ruby-identifier">increment</span>(<span class="ruby-ivar">@packet_length</span>)&#x000A;  <span class="ruby-ivar">@packet</span> = <span class="ruby-keyword">nil</span>&#x000A;&#x000A;  <span class="ruby-keyword">return</span> <span class="ruby-constant">Packet</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">payload</span>)&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a target="docwin" href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
